<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GrowthCircles LMS – Admin Dashboard</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 2rem;
    }
    h1 {
      text-align: center;
      color: #19486A;
      margin-bottom: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #19486A;
      color: #fff;
    }
    tr:hover {
      background: #f1f1f1;
    }
    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      margin-right: 6px;
    }
    .approve-btn {
      background: #26a69a;
      color: #fff;
    }
    .hold-btn {
      background: #f97316;
      color: #fff;
    }
    .comment-box {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .disabled-btn {
      background: #ccc !important;
      cursor: not-allowed;
    }
    #notificationBox {
      margin-top: 2rem;
      padding: 1rem;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: none;
    }
    #notificationBox h2 {
      margin-top: 0;
      color: #19486A;
    }
    #notifyMessage {
      width: 100%;
      height: 120px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      resize: none;
    }
  </style>
</head>
<body>
<h1>Applications – Admin Action</h1>

<!-- Filter Controls -->
<div id="filters" style="margin-bottom:1rem; display:flex; flex-wrap:wrap; gap:1rem;">
  <!-- (same filter controls as before) -->
  <select id="filterRoleApplied">...</select>
  <select id="filterRoleAssigned">...</select>
  <select id="filterStatus">...</select>
  <select id="filterVerification">...</select>
  <select id="filterSource">...</select>
  <input type="text" id="filterAdmin" placeholder="Filter by Admin Actor">
</div>

<!-- Table -->
<table id="applicationsTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Full Name</th>
      <th>Email</th>
      <th>Phone</th>
      <th>Country</th>
      <th>Location Details</th>
      <th>Role Applied</th>
      <th>Role Assigned</th>
      <th>Application Source</th>
      <th>Status</th>
      <th>Verification Status</th>
      <th>Submitted At</th>
      <th>Last Action At</th>
      <th>Admin Actor</th>
      <th>Portal Leasee Details</th>
      <th>Hubhost Details</th>
      <th>Expertise Provider Details</th>
      <th>Comment</th>
      <th>Decision Notes</th>
      <th>Notification Sent</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    <!-- Rows injected here -->
  </tbody>
</table>

<!-- Pagination Controls -->
<div id="pagination" style="margin-top:1rem; text-align:center;">
  <button id="prevPage">Previous</button>
  <span id="pageInfo"></span>
  <button id="nextPage">Next</button>
</div>

<script>
  let applications = [];
  let sortField = null;
  let sortDirection = 'asc';
  let currentPage = 1;
  const pageSize = 20; // records per page

  async function loadApplications() {
    const res = await fetch('/admin/applications');
    applications = await res.json();
    applyFilters(); // initial render with filters/sorting/pagination
  }

  function renderApplications(apps) {
    const tbody = document.querySelector('#applicationsTable tbody');
    tbody.innerHTML = '';

    // Pagination slice
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageApps = apps.slice(start, end);

    pageApps.forEach(app => {
      const isApproved = app.status && app.status.toLowerCase().includes('approved');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${app.id}</td>
        <td>${app.full_name}</td>
        <td>${app.email}</td>
        <td>${app.phone || ''}</td>
        <td>${app.country || ''}</td>
        <td>${app.location_details || ''}</td>
        <td>${app.role_applied}</td>
        <td>${app.role_assigned || ''}</td>
        <td>${app.application_source || ''}</td>
        <td class="status-cell">${app.status}</td>
        <td>${app.verification_status || ''}</td>
        <td>${app.submitted_at || ''}</td>
        <td>${app.last_action_at || ''}</td>
        <td>${app.admin_id || ''}</td>
        <td><input type="text" class="comment-box" value="${app.comment || ''}" ${isApproved ? 'disabled' : ''}></td>
        <td><input type="text" class="comment-box" value="${app.decision_notes || ''}" ${isApproved ? 'disabled' : ''}></td>
        <td>${app.notify_sent ? '✅' : '❌'}</td>
        <td>
          <button class="action-btn approve-btn ${isApproved ? 'disabled-btn' : ''}" ${isApproved ? 'disabled' : ''} onclick="updateStatus(${app.id}, 'approved', this)">Approve</button>
          <button class="action-btn hold-btn ${isApproved ? 'disabled-btn' : ''}" ${isApproved ? 'disabled' : ''} onclick="updateStatus(${app.id}, 'on hold', this)">On Hold</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // Update pagination info
    const pageInfo = document.getElementById('pageInfo');
    const totalPages = Math.ceil(apps.length / pageSize);
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === totalPages;
  }

  function applyFilters() {
    const roleApplied = document.getElementById('filterRoleApplied').value;
    const roleAssigned = document.getElementById('filterRoleAssigned').value;
    const status = document.getElementById('filterStatus').value;
    const verification = document.getElementById('filterVerification').value;
    const source = document.getElementById('filterSource').value;
    const adminActor = document.getElementById('filterAdmin').value.toLowerCase();

    let filtered = applications.filter(app => {
      return (!roleApplied || app.role_applied === roleApplied) &&
             (!roleAssigned || app.role_assigned === roleAssigned) &&
             (!status || app.status === status) &&
             (!verification || app.verification_status === verification) &&
             (!source || app.application_source === source) &&
             (!adminActor || (app.admin_id || '').toLowerCase().includes(adminActor));
    });

    if (sortField) {
      filtered.sort((a, b) => {
        let valA = a[sortField] || '';
        let valB = b[sortField] || '';
        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });
    }
	
	<select id="filterRoleApplied">
  <option value="">All Roles Applied</option>
  <option value="facilitator">Facilitator</option>
  <option value="trainee">Trainee</option>
  <option value="msme">MSME</option>
  <option value="donor">Donor</option>
  <option value="portal_leasee">Portal Leasee</option>
  <option value="hubhost">Hubhost</option>
  <option value="expertise_provider">Expertise Provider</option>
</select>

    renderApplications(filtered);
  }

  // Attach filter listeners
  document.querySelectorAll('#filters select, #filters input').forEach(el => {
    el.addEventListener('change', () => { currentPage = 1; applyFilters(); });
    el.addEventListener('keyup', () => { currentPage = 1; applyFilters(); });
  });

  // Sorting listeners
  document.querySelectorAll('#applicationsTable th[data-field]').forEach(th => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
      const field = th.getAttribute('data-field');
      if (sortField === field) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortField = field;
        sortDirection = 'asc';
      }
      applyFilters();
    });
  });

  // Pagination listeners
  document.getElementById('prevPage').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      applyFilters();
    }
  });
  document.getElementById('nextPage').addEventListener('click', () => {
    currentPage++;
    applyFilters();
  });

  loadApplications();
</script>

</body>
</html>
